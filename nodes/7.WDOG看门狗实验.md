# 1. 看门狗介绍
- WatchDog是为了==能够防止程序跑飞而使用的一种硬件模块==.
- 如果你的程序没有跑飞,那么你的**程序会定时的去喂看门狗**,如果你的程序跑飞了,那么就不会再去喂狗了,
- 如果**超过了喂狗的时间**,那么**狗就会自己生成一个信号来重新reset你的CPU**,重新开始.这是一种在很重要的情况下防止系统跑飞的一种方法.
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/f66d99b5b9cf4104b398bfaf85b31a1f.png)
# 2. IMX.6ull Watchdog Timer
- The `Watchdog Timer (WDOG)` `protects against system failures` by providing a method by which to `escape from unexpected events or programming errors`.
	- > 看门狗定时器（WDOG）通过提供一种逃避意外事件或编程错误的方法来防止系统故障。
- Once the WDOG is `activated`, it must be serviced by the software `on a periodic basis`.
-  If servicing does not take place, the timer times out. `Upon timeout, the WDOG asserts the internal system reset signal`, 
- `WDOG_RESET_B_DEB` to the System Reset Controller (`SRC`).
	- > 一旦WDOG被激活，软件必须定期对其进行维护。如果不进行维护，计时器超时。`超时时，WDOG断言内部系统复位信号`，`WDOG_RESET_B_DEB系统复位控制器（SRC）`。
	

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/e9c7c1545f4e40db950cd608e69ddb2f.png)
## 1.Clocks
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/36aae5e4f4b54b8185332cab21eb8d09.png)
## 2.Timeout event
- The WDOG provides `timeout periods` from `0.5 to 128 seconds `with a time resolution of 0.5 seconds.
	- > WDOG提供`0.5秒到128秒`的超时周期，时间分辨率为0.5秒。
- The user can determine the timeout period by writing to the `WDOG timeout field` (`WT[7:0]`) in the Watchdog Control Register (`WDOG_WCR`). 
	- > 用户可以通过写入`看门狗控制寄存器（WDOG_WCR）`中的WDOG超时字段（WT[7:0]）来确定超时周期。
	> ![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/7dabc38e729c443f85acfb62ffa724d3.png)

- The WDOG `must be enabled` by setting the `WDE` bit of Watchdog Control Register (`WDOG_WCR`) for the timeout counter to start running. 
	- > 须通过设置看门狗控制寄存器（WDOG_WCR）的WDE位来启用WDOG
	> ![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/f9938d008d094f82b7d691ebd0ff2e5a.png)


- After the WDOG is enabled, `the counter is activated,` loads the timeout value and begins to `count down` from this programmed value. 
	- > 启用WDOG后，计数器被激活，加载超时值并从该编程值开始倒计时。
- The timer will time out `when the counter reaches zero `and the `WDOG outputs a system reset signal`, `WDOG_RESET_B_DEB` and asserts `WDOG_B` (`WDT bit `should be set in Watchdog Control Register (WDOG_WCR)).
	- >计时器将在计数器达到零并且WDOG输出系统复位信号时超时,WDOG_RESET_B_DEB并断言WDOG_B（WDT位应在看门狗控制寄存器（WDOG_WCR）中设置）。
	>![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/19195dfc3b994a3cb37062f788b334fe.png)
	>![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/54d2047651f84e25be68668b13015e25.png)
- However, the timeout condition can be `prevented by reloading the counter with the new timeout value` (WT[7:0] of WDOG_WCR) if a `service routine` (see Servicing WDOG to reload the counter) `is performed before the counter reaches zero`.
	- > 但是，如果在计数器达到零之前执行服务例程（请参阅服务WDOG以重新加载计数器），则可以通过`使用新的超时值`（WDOG_WCR的WT[7:0]）重新加载计数器来防止超时条件。
## 3.Servicing WDOG to reload the counter
- To reload a `timeout value` to the counter the `proper service sequence` begins by writing `0x_5555` followed by `0x_AAAA` to the `Watchdog Service Registe`r (`WDOG_WSR`). 
	- > `要将超时值重新加载到计数器`，正确的服务序列首先写入0x_5555，然后0x_AAAA到看门狗服务寄存器（WDOG_WSR）。
	> ![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/680a5fa48fa048729631d3ea4ffc6522.png)
- Any number of instructions can be executed `between the two writes`. 
	- > 两次写入之间可以执行任意数量的指令。
- If the WDOG_WSR is not loaded with 0x_5555 prior to writing 0x_AAAA to the WDOG_WSR, `the counter is not reloaded`. 
	- > 如果WDOG_WSR在写入0x_AAA之前,没有加载0x_5555到WDOG_WSR ，则不会重新加载计数器。
- If any `value other than 0x_AAAA` is written to the WDOG_WSR after 0x_5555, the counter is not reloaded. This service sequence will reload the counter with the timeout value WT[7:0] of Watchdog Control Register (WDOG_WCR). 
	- > 如果在写入0x_5555后，写了0x_AAAA以外的任何值写入WDOG_WSR，则不会重新加载计数器。此服务序列将使用看门狗控制寄存器（WDOG_WCR）的超时值WT[7:0]重新加载计数器。
- The timeout value can be `changed at any point`; `it is reloaded` when `WDOG is serviced by the core`.
	- > 超时值可以在任何时候更改；当WDOG由内核提供服务时，它会被重新加载。

# 3. Watchdog Timer 重点寄存器
## 1.Watchdog Control Register (WDOGx_WCR)
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/f2498fbd61c743efb54b25fb061f426e.png)
## 2.Watchdog Service Register (WDOGx_WSR)
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/7e459bcc6883467793f1d6793160dbfc.png)
## 3.SRC Control Register (SRC_SCR)
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/b8bb42b8ab204cf1b16328acbbdb1062.png)
- ==冷启动==，Cold Reset, `cold reboot`, `cold boot`, `hard reboot`, 关闭电源，再打开电源重启计算机。
- ==热启动==，`Warm Reset`, `warm reboot`, `soft reboot`, 在不关闭电源的情况，由软件控制重启计算机。

# 4. 看门狗复位系统
## 1.实现思路
### 使能看门狗时钟
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/0191a6279bf941b69010e195d9860951.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/edaecadfa2414b838a456b338a59ad7d.png)

```c
/*Enable WDT Clock*/
    CCM_CCGR3 |= (0x3 << 16);
```

### 设置复位信号产生后以冷启动方式复位
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/4f84afc0fa874797b44a60821878575c.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/b8bb42b8ab204cf1b16328acbbdb1062.png)

```c
 /*wdt reset signal to cold reset*/
    SRC->SCR &= ~(1 << 0);

```

### 关闭看门狗控制器
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/59dbd7ff077b42f58b2d53cdedd59101.png)

```c
 /*
      WDE [2] 0 Disable the Watchdog (Default)
    */
    WDOG1->WCR &= ~(1 << 2); 
```

### 设置看门狗定时器定时时间
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/f07bb051cf394ad092a09e4cbaffc5c8.png)

```c
/*
      Wdt Timer 5s timeout((n + 1) * 2)
      WT [15:8] Watchdog Time-out Field.  
    */
    WDOG1->WCR &= ~(0xff << 8);
    WDOG1->WCR |=  (9 << 8);
```

### 使能看门狗
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/59dbd7ff077b42f58b2d53cdedd59101.png)

```c
/*
      WDE [2] 1 Enable the Watchdog.
    */
    WDOG1->WCR |= (1 << 2);

```

### 进行喂狗服务，重置看门狗定时器
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/3a84f027d2c24bbeb48c25348cee8271.png)

```c
void wdt_refresh(void)
{
    WDOG1->WSR = 0x5555;
    WDOG1->WSR = 0xaaaa;
    return;
}
```

### 不喂狗看门狗定时器超时，产生复位信号，复位开发板

## 2.代码实现

```c
#include"imx6ull.h"
#include"wdt.h"
#include"gpt.h"
#include"uart.h"

void wdt_init() {
    /*Enable WDT Clock*/
    CCM_CCGR3 |= (0x3 << 16);
    
    /*wdt reset signal to cold reset*/
    SRC->SCR &= ~(1 << 0);

    /*
      WDE [2] 0 Disable the Watchdog (Default)
    */
    WDOG1->WCR &= ~(1 << 2);

    /*
      Wdt Timer 5s timeout
      WT [15:8] Watchdog Time-out Field.  
    */
    WDOG1->WCR &= ~(0xff << 8);
    WDOG1->WCR |= (0x9 << 8);

    /*
      WDE [2] 1 Enable the Watchdog.
    */
    WDOG1->WCR |= (1 << 2);
}

void wdt_refresh() {
    WDOG1->WSR = 0x5555;
    WDOG1->WSR = 0xAAAA;
    
}

void wdt_test() {
    int i;

    uart_printf("wdt test ...\r\n");
    wdt_init();

    // 延时3秒启动开门狗
    uart_printf("Delay 3 second\r\n");
    gpt_delay_sec(3);
    wdt_refresh();
    uart_printf("WDT Refresh Done\r\n");

    // 10秒内不进行喂狗，观察是否重启
    for(i = 0;i < 10;i ++){
        uart_printf("Wait reset %d\r\n",i);
        gpt_delay_sec(1);
    }
}

```
## 3.测试结果展示
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/9f6be27460a449d093637c7d065c5aaa.png)